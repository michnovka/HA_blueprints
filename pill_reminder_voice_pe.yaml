blueprint:
  name: "Pill Reminder LED with Multiple Times and Custom Colors"
  description: >
    This blueprint turns on an LED light at one or more specified times as a pill reminder.
    The LED is set to the configured pill reminder color and brightness. When a specified
    button event occurs (for example, a double_press or triple_press), the LED is first
    configured to its idle settings and then turned off.
  domain: automation
  input:
    pill_times:
      name: "Reminder Times"
      description: "List of times to trigger the pill reminder."
      default: ["08:00:00"]
      selector:
        multiple:
          selector:
            time: {}
    led_light:
      name: "LED Light"
      description: "The LED light to control."
      selector:
        entity:
          domain: light
    button_event_entity:
      name: "Button Event Entity"
      description: "The entity that records button press events (it updates its state with a timestamp and an attribute 'event_type')."
      selector:
        entity: {}
    button_press_type:
      name: "Button Press Type"
      description: "The type of press (e.g., double_press or triple_press) required to trigger turning off the LED."
      default: double_press
      selector:
        select:
          options:
            - double_press
            - triple_press
    pill_rgb_color:
      name: "Pill Reminder Color"
      description: "The RGB color for the LED when the pill reminder is activated (as an array, e.g. [255, 0, 0])."
      default: [255, 0, 0]
      selector:
        color_rgb: {}
    pill_brightness:
      name: "Pill Reminder Brightness (%)"
      description: "The brightness percentage for the LED when the pill reminder is activated."
      default: 100
      selector:
        number:
          min: 1
          max: 100
    idle_rgb_color:
      name: "Idle LED Color"
      description: "The RGB color for the LED when reverting to its idle state (as an array, e.g. [108, 95, 252])."
      default: [108, 95, 252]
      selector:
        color_rgb: {}
    idle_brightness:
      name: "Idle LED Brightness (%)"
      description: "The brightness percentage for the LED when reverting back to idle state."
      default: 50
      selector:
        number:
          min: 1
          max: 100

trigger:
  # Create a time trigger for each specified reminder time.
  - platform: time
    for_each: !input pill_times
    at: "{{ item }}"
    id: "daily_time_trigger_{{ item }}"
  # Trigger on changes to the button event entity's state.
  - platform: state
    entity_id: !input button_event_entity
    id: button_press_event

action:
  - choose:
      # Branch for the time trigger: turn on the LED in the pill reminder color and brightness.
      - conditions:
          - condition: template
            value_template: "{{ trigger.id.startswith('daily_time_trigger') }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input led_light
            data:
              rgb_color: !input pill_rgb_color
              brightness_pct: !input pill_brightness

      # Branch for the button event: if the new state's attribute 'event_type' equals the specified button_press_type
      # and if the LED is currently on, then set the LED to the idle color+brightness and turn it off.
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.id == 'button_press_event' and
                 trigger.to_state.attributes.event_type == inputs.button_press_type }}
          - condition: state
            entity_id: !input led_light
            state: "on"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input led_light
            data:
              rgb_color: !input idle_rgb_color
              brightness_pct: !input idle_brightness
          - service: light.turn_off
            target:
              entity_id: !input led_light
mode: single
